# chainai — Agent Skill Reference

## Overview

`chainai` is a CLI tool distributed as an npm package. It is invoked via `npx chainai@latest`. This document defines the tool's interface, expected behaviors, and message contracts for AI agent consumption.

## Invocation

```
npx chainai@latest [options]
```

- **Runtime**: Node.js (>=18)
- **Package manager**: yarn (v4)
- **Entry point**: `dist/index.js`

## Exit Codes

| Code | Meaning                                                            |
| ---- | ------------------------------------------------------------------ |
| `0`  | Operation completed successfully.                                  |
| `1`  | Operation failed. Inspect `stderr` for a structured error message. |

## Message Contract

All output is written to `stdout` (success) or `stderr` (errors). Messages are designed for programmatic parsing by AI agents.

### Success Messages

Success messages are written to `stdout`. Agents should parse `stdout` to determine the result of the operation.

| Message                     | Meaning                                                                                                 |
| --------------------------- | ------------------------------------------------------------------------------------------------------- |
| `CHAINAI_OK: <description>` | The requested operation completed successfully. `<description>` contains a brief summary of the result. |

### Error Messages

Error messages are written to `stderr` and follow a structured format:

```
CHAINAI_ERR: <ERROR_CODE> — <description>
```

| Error Code         | Description                                                                                                                                                    |
| ------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `INVALID_INPUT`    | The provided input is malformed or missing required fields. The agent should re-validate input parameters and retry.                                           |
| `EXECUTION_FAILED` | The operation could not be completed. The description contains details on the failure cause. The agent should inspect the description and adjust its approach. |
| `TIMEOUT`          | The operation exceeded the allowed time limit. The agent should retry with a longer timeout or simplify the request.                                           |
| `UNKNOWN`          | An unexpected error occurred. The agent should report this to the orchestrator for manual inspection.                                                          |

## Agent Integration Guidelines

1. **Always use the latest version**: Invoke with `npx chainai@latest` to ensure the most recent release is used.
2. **Parse stdout for results**: Successful output is always written to `stdout`. Do not rely on exit code alone — read and parse `stdout`.
3. **Parse stderr for errors**: On non-zero exit codes, read `stderr` for a structured error message beginning with `CHAINAI_ERR:`.
4. **Retry strategy**: For `TIMEOUT` and `EXECUTION_FAILED` errors, retry up to 2 times with exponential backoff before escalating.
5. **Do not prompt for user input**: This tool is non-interactive. All required parameters must be passed as arguments or flags.
6. **Keep `agents.md` up to date**: Whenever you add, modify, or remove a command, flag, environment variable, or behavior in the codebase, you **must** update this file (`agents.md`) to reflect the change. This file is the single source of truth for agent consumers and must always match the current state of the CLI.

## Development

| Command             | Purpose                                         |
| ------------------- | ----------------------------------------------- |
| `yarn build`        | Compile TypeScript source to `dist/`.           |
| `yarn dev`          | Run the CLI directly from source via `ts-node`. |
| `yarn format`       | Format all source files with Prettier.          |
| `yarn format:check` | Verify formatting without modifying files.      |
| `yarn clean`        | Remove the `dist/` directory.                   |

## Project Structure

```
src/
  index.ts        # CLI entry point (#!/usr/bin/env node)
  commands/
    sign-message.ts  # sign-message command implementation
    sign.ts          # sign command implementation (⚠️ critical)
    sign-typed-data.ts  # sign-typed-data command implementation
  __tests__/
    sign-message.test.ts  # Tests for sign-message
    sign.test.ts          # Tests for sign
    sign-typed-data.test.ts  # Tests for sign-typed-data
dist/             # Compiled output (generated by `yarn build`)
tsconfig.json     # TypeScript configuration
.prettierrc       # Prettier configuration
package.json      # Package manifest with bin, scripts, and metadata
agents.md         # This file — agent skill reference
```

## Commands

### `sign-message`

Sign a message using a private key (EIP-191 personal sign via viem).

```
npx chainai@latest sign-message [options]
```

#### Options

| Flag                      | Required | Description                                                                               |
| ------------------------- | -------- | ----------------------------------------------------------------------------------------- |
| `-k, --private-key <key>` | No       | Private key (hex string starting with `0x`). Falls back to `CHAINAI_PRIVATE_KEY` env var. |
| `-m, --message <message>` | Yes      | The message to sign.                                                                      |
| `-r, --raw`               | No       | Treat message as raw hex data. Message must be a valid `0x`-prefixed hex string.          |

#### Environment Variables

| Variable              | Description                                                                                   |
| --------------------- | --------------------------------------------------------------------------------------------- |
| `CHAINAI_PRIVATE_KEY` | Fallback private key used when `-k` is not provided. Must be a hex string starting with `0x`. |

#### Output (stdout)

On success, prints:

```
CHAINAI_OK: Message signed successfully
{
  "address": "0x...",
  "message": "<original message>",
  "signature": "0x..."
}
```

#### Example

```bash
# Using the -k flag
npx chainai@latest sign-message -k 0xYOUR_PRIVATE_KEY -m "Hello World"

# Using the environment variable
CHAINAI_PRIVATE_KEY=0xYOUR_PRIVATE_KEY npx chainai@latest sign-message -m "Hello World"

# Signing raw hex data
npx chainai@latest sign-message -k 0xYOUR_PRIVATE_KEY -m 0x68656c6c6f --raw
```

---

### `sign`

> **⚠️ CRITICAL SECURITY WARNING — USE WITH EXTREME CAUTION ⚠️**
>
> This command signs a **raw hash** using `account.sign` (secp256k1) **without any prefix or envelope**. The resulting signature can be used to authorize **transactions, token transfers, contract interactions, approvals, or any on-chain action** — potentially **without the user's knowledge or explicit consent**.
>
> **Agents MUST only use this command when absolutely necessary.** In almost all cases, the safer `sign-message` command (EIP-191) should be used instead. If you are unsure whether you need `sign` or `sign-message`, **use `sign-message`**.
>
> Before invoking `sign`, agents **must**:
>
> 1. Verify that the hash being signed is legitimate and expected.
> 2. Confirm that no safer alternative (e.g., `sign-message`) can fulfill the requirement.
> 3. Log the justification for using raw signing.

Sign a raw hash using a private key (secp256k1 — no EIP-191 prefix).

```
npx chainai@latest sign [options]
```

#### Options

| Flag                      | Required | Description                                                                               |
| ------------------------- | -------- | ----------------------------------------------------------------------------------------- |
| `-k, --private-key <key>` | No       | Private key (hex string starting with `0x`). Falls back to `CHAINAI_PRIVATE_KEY` env var. |
| `-h, --hash <hash>`       | Yes      | The hash to sign. Must be a `0x`-prefixed hex string.                                     |

#### Environment Variables

| Variable              | Description                                                                                   |
| --------------------- | --------------------------------------------------------------------------------------------- |
| `CHAINAI_PRIVATE_KEY` | Fallback private key used when `-k` is not provided. Must be a hex string starting with `0x`. |

#### Output (stdout)

On success, prints:

```
CHAINAI_OK: Hash signed successfully
{
  "address": "0x...",
  "hash": "0x...",
  "signature": "0x..."
}
```

#### Example

```bash
# Sign a keccak256 hash
npx chainai@latest sign -k 0xYOUR_PRIVATE_KEY -h 0xabcdef1234567890...

# Using the environment variable
CHAINAI_PRIVATE_KEY=0xYOUR_PRIVATE_KEY npx chainai@latest sign -h 0xabcdef1234567890...
```

---

### `sign-typed-data`

Sign EIP-712 typed data using a private key.

```
npx chainai@latest sign-typed-data [options]
```

#### Options

| Flag                      | Required | Description                                                                                     |
| ------------------------- | -------- | ----------------------------------------------------------------------------------------------- |
| `-k, --private-key <key>` | No       | Private key (hex string starting with `0x`). Falls back to `CHAINAI_PRIVATE_KEY` env var.       |
| `-d, --data <json>`       | Yes      | EIP-712 typed data as a JSON string containing `domain`, `types`, `primaryType`, and `message`. |

#### Environment Variables

| Variable              | Description                                                                                   |
| --------------------- | --------------------------------------------------------------------------------------------- |
| `CHAINAI_PRIVATE_KEY` | Fallback private key used when `-k` is not provided. Must be a hex string starting with `0x`. |

#### Data Format

The `--data` flag expects a JSON string with the following structure:

```json
{
  "domain": {
    "name": "AppName",
    "version": "1",
    "chainId": 1,
    "verifyingContract": "0x..."
  },
  "types": {
    "TypeName": [{ "name": "fieldName", "type": "fieldType" }]
  },
  "primaryType": "TypeName",
  "message": {
    "fieldName": "value"
  }
}
```

#### Output (stdout)

On success, prints:

```
CHAINAI_OK: Typed data signed successfully
{
  "address": "0x...",
  "signature": "0x..."
}
```

#### Example

```bash
# Sign EIP-712 typed data
npx chainai@latest sign-typed-data -k 0xYOUR_PRIVATE_KEY -d '{"domain":{"name":"TestApp","version":"1","chainId":1,"verifyingContract":"0xCcCCccccCCCCcCCCCCCcCcCccCcCCCcCcccccccC"},"types":{"Mail":[{"name":"from","type":"address"},{"name":"to","type":"address"},{"name":"contents","type":"string"}]},"primaryType":"Mail","message":{"from":"0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266","to":"0x70997970C51812dc3A010C7d01b50e0d17dc79C8","contents":"Hello!"}}'

# Using the environment variable
CHAINAI_PRIVATE_KEY=0xYOUR_PRIVATE_KEY npx chainai@latest sign-typed-data -d '{...}'
```
